# 项目背景
目前，国内患者获取个人健康医疗信息的主要方式是：医疗机构病案室复印或打印、医疗机构机器自助打印、医疗机构网络在线查询和区域卫生信息查询平台。患者获取的个人病历信息既不完整也不能下载整合，获得的碎片化数据，对后期患者对个人数据分析和再利用造成了障碍。


# 当归个人健康档案
在上述背景下发起的“当归”个人健康档案开源项目，寓意个人的健康医疗信息应当归还给患者，希望最终通过提供标准化的PHR（personal health record，个人健康档案）格式规范和工具，实现患者能够获取到一份完整、规范、标准化、可再利用的档案，让信息相关者从中获益。
项目参与方共同对PHR格式进行制定，共同讨论达成共识确定PHR格式中应包含内容，需兼容的格式，建立出符合行业应用和个人管理需求的PHR格式规范。

## 概念
当归PHR格式，是符合行业应用和个人管理需求的个人健康档案格式规范，参考卫计委发布的健康档案共享规范、电子病历共享规范制定。

## 作用
PHR格式，实现从医院信息系统、可穿戴健康设备、健康医疗相关应用程序等获取的个人健康医疗信息的汇聚，帮助个人有效管理自己完整的健康医疗信息。
- 在PHR管理工具中使用PHR格式，实现患者在安全、私密的环境下对其健康医疗信息的访问、管理和维护，使患者成为自己健康医疗信息的主人，全面参与个人健康医疗管理。
- 患者可以向医疗服务提供者展示本人健康档案，获得更好的诊治或服务。

## 特征
PHR档案需要有以下几个特征。
- 开放性：PHR格式是开发给所有开发者的，所有医疗结构、智能设备、应用开发商甚至用户自己都可以操作文档
- 统一性：PHR格式有自己的规范，接入者需要遵守PHR格式的规范，这样让所有的接入内容有统一的表达形式
- 兼容性：PHR格式需要兼容国标格式、自定义格式甚至图片、视频、音频等非结构化文档。
- 扩展性：PHR格式兼容的内容会随着开发者的加入越来越多，所以需要有较好的扩展性。
- 保密性：PHR格式由于记载用户的个人健康信息，需要有较强的保密性，以保证用户隐私不会被泄露。

# 当归个人健康档案格式定义
当归PHR格式文档为一个后缀名.phr.zip的文档。该文档为PHR档案的压缩包，使用zip进行压缩以实现全平台通用。PHR文档的组织方式如下所示：

```
sample.phr/
    index.xml
    id_folder/
        record.xml
        record.png
```
每个.phr文档都有一个目录文件index.xml，其中记录了文档主人的基本信息和健康记录流。针对健康记录流中的每一条记录，都会有一个与之id名相同的文件夹，该文件夹中保存了健康记录流中的源文件和资源文件。

## 目录文件

下面是一个目录文件的例子。
```xml
<?xml version="1.0" encoding="utf-8"?>
<phr>

<!--基本信息-->
<personalInfo>
    <!--姓名-->
    <name>张某某</name>
    <!--性别-->
    <gender>男</gender>
    <!--出生日期-->
    <birth>19900901</birth>
    <!--民族-->
    <nation>汉</nation>
</personalInfo>

<!--健康信息流-->
<records>
    <!--机构导入的结构化数据，符合国标-->
    <record>
        <!--记录唯一表示符-->
        <id>28c7265c65d13b54cd50b09ad3d51a17</id>
        <!--记录来源:
            0~2
            0:机构导入
            1:智能设备导入
            2:用户输入-->
        <from>0</from>
        <!--记录创建时间-->
        <createTime>20180115</createTime>
        <!--记录最新修改时间-->
        <updateTime>201704051123</dateTime>
        <!--记录描述，可以是用户自己填写，也可以是格式化文档的摘要，可选-->
        <text>张某某-门诊病例-20170405</text>
        <!--记录原始文件路径，格式化文档，可选-->
        <path>./1f4429d0-f12c-11e7-8c3f-9a214cf093ae/张某某-门诊病例-20170405.xml</path>
        <!--相关资源文件，非格式化文档，可选-->
        <resources/>
        <!--记录内容类型, 记录的内容属于哪个范畴，需要设定内容,例如0002代表门（急）诊病例-->
        <contentType>000002</contentType>
        <!--记录格式类型, 记录的格式符合哪种规范-->
        <formatType>
            <!--标准系统，国标支持的用国标编码-->
            <codeSystem>2.16.156.10011.2.4</codeSystem>
            <!--标准代码-->
            <code>C0002</code>
        </formatType>
        <!--机构信息-->
        <organization>
            <!--机构系统-->
            <orgSystem></orgSystem>
            <!--机构编码-->
            <orgCode></orgCode>
            <!--机构名称-->
            <orgName>XX医院</orgName>
            <!--机构内部就诊号-->
            <clinicID>YY00000001</clinicID>
        </organization>
    </record>

    <!--设备导入的非结构化数据-->
    <record>
        <!--记录唯一表示符-->
        <id>7ba89304-f41b-11e7-8c3f-9a214cf093ae</id>
        <!--记录来源:
            0~2
            0:机构导入
            1:智能设备导入
            2:用户输入-->
        <from>1</from>
        <!--记录创建时间-->
        <createTime>201704051123</createTime>
        <!--记录最新修改时间-->
        <updateTime>201704121123</dateTime>
        <!--记录描述，可以是用户自己填写，也可以是格式化文档的摘要，可选-->
        <text>心率</text>
        <!--记录原始文件路径，格式化文档，可选-->
        <path/>
        <!--相关资源文件，非格式化文档，可选-->
        <resources>
            <resource>./7ba89304-f41b-11e7-8c3f-9a214cf093ae/20170405-20170412-心率.png</resource>
        </resources>
        <!--记录内容类型, 记录的内容属于哪个范畴，需要设定内容,例如00007代表某设备的输出结果-->
        <contentType>00007</contentType>
        <!--记录格式类型, 记录的格式符合哪种规范-->
        <formatType>
            <!--标准系统，例如phr-format表示phr支持的自定义格式标准-->
            <codeSystem>STD</codeSystem>
            <!--标准代码-->
            <code>S_PNG</code>
        </formatType>
        <!--设备信息-->
        <device>
            <!--设备名称-->
            <deviceName>XX手环</deviceName>
            <!--设备ID-->
            <deviceID>c27746c2-f15a-11e7-8c3f-9a214cf093ae</deviceID>
        </device>
        <!--来源软件，可选-->
        <app>
            <!--软件名-->
            <appName>XX手环数据大师</appName>
            <!--软件ID-->
            <appID>7ba8944e-f41b-11e7-8c3f-9a214cf093ae</appID>
        </app>
    </record>

</records>

</phr>
```

其中`personalInfo`标签记录用户的个人信息，它包含以下几项内容：


内容| 标签 | 是否必须
---|---|---
姓名 | name | 是
性别 | gender | 是
出生日期| birth| 是
民族| nation | 是

`records`标签记录用户的健康数据流，每一个`record`对应于用户的一条健康数据。它包含以下内容：

内容| 标签 | 是否必须
---|---|---
ID | id | 是
来源 | from | 是
记录创建时间| createTime | 是
记录最近修改时间| updateTime | 是
记录描述| text | 否
记录原始文件地址| path | 否
记录资源文件地址| resources | 否
记录内容类型| contentType | 是
记录格式类型| formatType | 是
机构信息| organization | 否
设备信息| device | 否
软件信息| app | 否

`from`表示记录的来源, 具体含义如下：

取值 | 含义
---|---
0 | 机构导入
1 | 设备导入
2 | 用户导入

其中`resources`可以为多个，每个`resource`表示一个资源文件的地址。`organization` 为机构信息，包含以下内容：

内容| 标签 | 是否必须
---|---|---
机构ID | orgID | 否
机构名称 | orgName | 否
机构内部就诊号| clinicID | 否


`device`表示设备信息，包含以下内容：

内容| 标签 | 是否必须
---|---|---
设备ID | deviceID | 否
设备型号 | deviceType | 否
设备名称 | deviceName | 否

`app`表示软件信息，包含以下内容：
内容| 标签 | 是否必须
---|---|---
软件ID | appID | 否
软件名称 | appName | 否

下面对于目录文件中的ID生成、内容类型和格式类型将做详细说明。

## ID生成

### 记录ID
根据用户的`姓名+创建记录时间的timeStamp+随机数`生成md5值，例如张某某于`Mon Jan 15 2018 10:58:15 GMT+0800 (CST)`创建的记录，可用`张某某1515985095167.5792601392815107`生成的md5值`28c7265c65d13b54cd50b09ad3d51a17`作为记录ID。

### 机构ID
注册于OMAHA联盟的机构，将会有独有的机构ID，未注册的机构可根据机构名称，生成md5值，获取一个临时ID。例如，树兰医院注册于OMAHA，机构ID为`H00000001`，某某医院未注册，md5值为`c625b959cb6c4268ff32c441292667b6`, 机构ID为`c625b959cb6c4268ff32c441292667b6`。对于注册的机构，会提据不同的医院名称映射到同一个ID的服务。

### 设备ID
根据不同设备生成设备唯一标识符，对于联网设备可以用设备的MAC地址，对于通讯设备可以用IMEI码等，也可以用户自定义全局唯一ID (GUID)，只需要同一台设备用每次用相同策略生成即可

### 软件ID
根据软件平台生成软件的唯一标识符，例如iOS平台可以用的`Bundle ID`和Android平台的`Application ID`等。


## 内容类型
PHR内容类型`contentType`表示PHR记录的内容包含的信息类型。根据中华人民共和国卫生行业标准电子病历共享文档规范和健康档案共享文档规范编写。

其中编码前两位表示内容分类，如下表：

编码前两位 | 含义
---|---
00 | 电子病历共享文档规范的内容分类
01 | 健康档案共享文档规范的内容分类
99 | 上述标准不涵盖的内容分类

后四位表示对应内容分类下具体的文档内容，如下表：

标准| 内容 | 编码
---| ---|---
电子病历共享文档规范|病历概要| 000001
电子病历共享文档规范|门（急）诊病历| 000002
电子病历共享文档规范|急诊留观病历| 000003
电子病历共享文档规范|西药处方| 000004
电子病历共享文档规范|中药处方| 000005
电子病历共享文档规范|检查报告| 000006
电子病历共享文档规范|检验报告| 000007
电子病历共享文档规范|治疗记录| 000008
电子病历共享文档规范|一般手术记录| 000009
电子病历共享文档规范|麻醉术前访视记录| 000010
电子病历共享文档规范|麻醉记录| 000011
电子病历共享文档规范|麻醉术后访视记录| 000012
电子病历共享文档规范|输血记录| 000013
电子病历共享文档规范|待产记录| 000014
电子病历共享文档规范|阴道分娩记录| 000015
电子病历共享文档规范|剖宫产记录| 000016
电子病历共享文档规范|一般护理记录| 000017
电子病历共享文档规范|病重（病危）护理记录| 000018
电子病历共享文档规范|手术护理记录| 000019
电子病历共享文档规范|生命体征测量记录| 000020
电子病历共享文档规范|出入量记录| 000021
电子病历共享文档规范|高值耗材使用记录| 000022
电子病历共享文档规范|入院评估| 000023
电子病历共享文档规范|护理计划| 000024
电子病历共享文档规范|出院评估与指导| 000025
电子病历共享文档规范|手术知情同意书| 000026
电子病历共享文档规范|麻醉知情同意书| 000027
电子病历共享文档规范|输血治疗同意书| 000028
电子病历共享文档规范|特殊检查及特殊治疗同意书| 000029
电子病历共享文档规范|病危（重）通知书| 000030
电子病历共享文档规范|其他知情同意书| 000031
电子病历共享文档规范|住院病案首页| 000032
电子病历共享文档规范|中医住院病案首页| 000033
电子病历共享文档规范|入院记录| 000034
电子病历共享文档规范|24小时内入出院记录| 000035
电子病历共享文档规范|24小时内入院死亡记录| 000036
电子病历共享文档规范|住院病程记录 首次病程记录| 000037
电子病历共享文档规范|住院病程记录 日常病程记录| 000038
电子病历共享文档规范|住院病程记录 上级医师查房记录| 000039
电子病历共享文档规范|住院病程记录 疑难病例讨论记录| 000040
电子病历共享文档规范|住院病程记录 交接班记录| 000041
电子病历共享文档规范|住院病程记录 转科记录| 000042
电子病历共享文档规范|住院病程记录 阶段小结| 000043
电子病历共享文档规范|住院病程记录 抢救记录| 000044
电子病历共享文档规范|住院病程记录 会诊记录| 000045
电子病历共享文档规范|住院病程记录 术前小结| 000046
电子病历共享文档规范|住院病程记录 术前讨论| 000047
电子病历共享文档规范|住院病程记录 术后首次病程记录| 000048
电子病历共享文档规范|住院病程记录 出院记录| 000049
电子病历共享文档规范|住院病程记录 死亡记录| 000050
电子病历共享文档规范|住院病程记录 死亡病例讨论记录| 000051
电子病历共享文档规范|住院医嘱| 000052
电子病历共享文档规范|出院小结| 000053
健康档案共享文档规范|个人基本健康信息登记| 010001
健康档案共享文档规范|出生医学证明| 010002
健康档案共享文档规范|新生儿家庭访视| 010003
健康档案共享文档规范|儿童健康体检| 010004
健康档案共享文档规范|首次产前随访服务| 010005
健康档案共享文档规范|产前随访服务| 010006
健康档案共享文档规范|产后访视| 010007
健康档案共享文档规范|产后42天健康检查| 010008
健康档案共享文档规范|预防接种报告| 010009
健康档案共享文档规范|传染病报告| 010010
健康档案共享文档规范|死亡医学证明| 010011
健康档案共享文档规范|高血压患者随访服务| 010012
健康档案共享文档规范|2型糖尿病患者随访服务| 010013
健康档案共享文档规范|重性精神疾病患者个人信息登记| 010014
健康档案共享文档规范|重性精神疾病患者随访服务| 010015
健康档案共享文档规范|成人健康体检| 010016
健康档案共享文档规范|门诊摘要| 010017
健康档案共享文档规范|住院摘要| 010018
健康档案共享文档规范|会诊记录| 010019
健康档案共享文档规范|转诊（院）记录| 010020
其他规范| 基因检测报告| 990001

注意：
 
- `contentType`表示文档内容为对应规范指定内容的范畴，不需要严格遵守文档规范的格式，甚至可以是非结构化文档。
- 如果文档内容为某规范指定类型的子集，`contentType`也填写改规范对应的内容类型编码，可在软件层面做合并。

## 格式类型
PHR格式类型`formatType`表示PHR记录的格式遵循的规范。格式信息用`codeSystem`表示格式遵循的规范。用`code`信息具体规范中的文档格式。目前涵盖了中华人民共和国卫生行业标准电子病例共享文档规范和健康档案共享文档规范。

格式分类系统`codeSystem`目前包含三种取值，含义如下：

codeSystem | 含义
---|---
2.16.156.10011.2.4 | 卫生行业标准格式
PHR |  PHR自定义格式
STD |  通用标准格式

格式代码`code`指具体的格式标准，含义如下：


格式标准 |后缀名| codeSystem| code
---|---|---|---
病历概要 |xml| 2.16.156.10011.2.4 | C0001
门（急）诊病历 |xml| 2.16.156.10011.2.4| C0002
急诊留观病历 |xml| 2.16.156.10011.2.4| C0003
西药处方 |xml| 2.16.156.10011.2.4| C0004
中药处方 |xml| 2.16.156.10011.2.4| C0005
检查报告 |xml| 2.16.156.10011.2.4| C0006
检验报告 |xml| 2.16.156.10011.2.4| C0007
治疗记录 |xml| 2.16.156.10011.2.4| C0008
一般手术记录 |xml| 2.16.156.10011.2.4| C0009
麻醉术前访视记录 |xml| 2.16.156.10011.2.4| C0010
麻醉记录 |xml| 2.16.156.10011.2.4| C0011
麻醉术后访视记录 |xml| 2.16.156.10011.2.4| C0012
输血记录 |xml| 2.16.156.10011.2.4| C0013
待产记录 |xml| 2.16.156.10011.2.4| C0014
阴道分娩记录 |xml| 2.16.156.10011.2.4| C0015
剖宫产记录 |xml| 2.16.156.10011.2.4| C0016
一般护理记录 |xml| 2.16.156.10011.2.4| C0017
病重（病危）护理记录 |xml| 2.16.156.10011.2.4| C0018
手术护理记录 |xml| 2.16.156.10011.2.4| C0019
生命体征测量记录 |xml| 2.16.156.10011.2.4| C0020
出入量记录 |xml| 2.16.156.10011.2.4 | C0021
高值耗材使用记录 |xml| 2.16.156.10011.2.4 | C0022
入院评估 |xml| 2.16.156.10011.2.4 | C0023
护理计划 |xml| 2.16.156.10011.2.4 | C0024
出院评估与指导 |xml| 2.16.156.10011.2.4 | C0025
手术知情同意书 |xml| 2.16.156.10011.2.4 | C0026
麻醉知情同意书 |xml| 2.16.156.10011.2.4 | C0027
输血治疗同意书 |xml| 2.16.156.10011.2.4 | C0028
特殊检查及特殊治疗同意书 |xml| 2.16.156.10011.2.4 | C0029
病危（重）通知书 |xml| 2.16.156.10011.2.4 | C0030
其他知情同意书 |xml| 2.16.156.10011.2.4 | C0031
住院病案首页 |xml| 2.16.156.10011.2.4 | C0032
中医住院病案首页 |xml| 2.16.156.10011.2.4 | C0033
入院记录 |xml| 2.16.156.10011.2.4 | C0034
24小时内入出院记录 |xml| 2.16.156.10011.2.4 | C0035
24小时内入院死亡记录 |xml| 2.16.156.10011.2.4 | C0036
住院病程记录 首次病程记录 |xml| 2.16.156.10011.2.4 | C0037
住院病程记录 日常病程记录 |xml| 2.16.156.10011.2.4 | C0038
住院病程记录 上级医师查房记录 |xml| 2.16.156.10011.2.4 | C0039
住院病程记录 疑难病例讨论记录 |xml| 2.16.156.10011.2.4 | C0040
住院病程记录 交接班记录 |xml| 2.16.156.10011.2.4 | C0041
住院病程记录 转科记录 |xml| 2.16.156.10011.2.4 | C0042
住院病程记录 阶段小结 |xml| 2.16.156.10011.2.4 | C0043
住院病程记录 抢救记录 |xml| 2.16.156.10011.2.4 | C0044
住院病程记录 会诊记录 |xml| 2.16.156.10011.2.4 | C0045
住院病程记录 术前小结 |xml| 2.16.156.10011.2.4 | C0046
住院病程记录 术前讨论 |xml| 2.16.156.10011.2.4 | C0047
住院病程记录 术后首次病程记录 |xml| 2.16.156.10011.2.4 | C0048
住院病程记录 出院记录 |xml| 2.16.156.10011.2.4 | C0049
住院病程记录 死亡记录 |xml| 2.16.156.10011.2.4 | C0050
住院病程记录 死亡病例讨论记录 |xml| 2.16.156.10011.2.4 | C0051
住院医嘱 |xml| 2.16.156.10011.2.4 | C0052
出院小结 |xml| 2.16.156.10011.2.4 | C0053
个人基本健康信息登记 |xml| 2.16.156.10011.2.4 | HSDA00.01
出生医学证明 |xml| 2.16.156.10011.2.4 | HSDB01.01
新生儿家庭访视 |xml| 2.16.156.10011.2.4 | HSDB01.02
儿童健康体检 |xml| 2.16.156.10011.2.4 | HSDB01.03
首次产前随访服务 |xml| 2.16.156.10011.2.4 | HSDB02.01
产前随访服务 |xml| 2.16.156.10011.2.4 | HSDB02.02
产后访视 |xml| 2.16.156.10011.2.4 | HSDB02.03
产后42天健康体检 |xml| 2.16.156.10011.2.4 | HSDB02.04
预防接种报告 |xml| 2.16.156.10011.2.4 | HSDB03.01
传染病报告 |xml| 2.16.156.10011.2.4 | HSDB03.02
死亡医学证明 |xml| 2.16.156.10011.2.4 | HSDB03.03
高血压患者随访服务 |xml| 2.16.156.10011.2.4 | HSDB04.01
2型糖尿病患者随访服务 |xml| 2.16.156.10011.2.4 | HSDB04.02
重性精神疾病患者个人信息登记 |xml| 2.16.156.10011.2.4 | HSDB04.03
重性精神疾病患者随访服务 |xml| 2.16.156.10011.2.4 | HSDB04.04
成人健康体检 |xml| 2.16.156.10011.2.4 | HSDC00.01
门诊摘要 |xml| 2.16.156.10011.2.4 | HSDC00.02
住院摘要 |xml| 2.16.156.10011.2.4 | HSDC00.03
会诊记录 |xml| 2.16.156.10011.2.4 | HSDC00.04
转诊（院）记录 |xml| 2.16.156.10011.2.4 | HSDC00.05
基因数据格式|snp.gff| PHR| P0001
影像数据格式|dcm| PHR| P0002
标准JPG格式|jpg| STD| S_JPG
标准PNG格式|png|STD| S_PNG
标准PDF格式|pdf| STD| S_PDF
标准DOC格式|doc| STD| S_DOC
标准DOCX格式|docx| STD| S_DOCX
标准XSL格式|xsl| STD| S_XSL
标准XSLX格式|xslx| STD| S_XSLX
标准PPT格式|ppt| STD| S_PPT
标准PPTX格式|pptx| STD| S_PPTX
标准MKV格式|mkv| STD| S_MKV
标准AVI格式|avi| STD| S_AVI
标准RMVB格式|rmvb| STD| S_RMVB
标准MP4格式|mp4| STD| S_MP4
标准WMV格式|wmv| STD| S_WMV
标准MP3格式|mp3| STD| S_MP3
标准WMA格式|wma| STD| S_WMA
标准AMR格式|amr| STD| S_AMR
标准AAC格式|aac| STD| S_AAC
标准TXT格式|txt| STD| S_TXT
标准RAR格式|rar| STD| S_RAR
标准ZIP格式|zip| STD| S_ZIP

## 资源文件夹

资源文件夹数量与记录流中记录数量一致，资源文件夹名与记录ID一致。资源文件夹可以存储健康文档原始数据，也可以存储图片、视频、音频等资源数据。

## 档案保密性

建议通过两方面保证个人健康档案的保密性：

- 对档案本身进行加密
- 软件层面对用户进行认证

### 档案加密

由于对称加密有加密速度快的优点，而非对称加密保密性更高，建议针对文档的加密采用以下方式：
- 用非对称加密加密对称加密的密钥
- 用对称加密的密钥加密档案内容

推荐的加密流程如下：
- 生成RSA公钥和私钥
- 生成AES密钥
- 用AES密钥对PHR文档进行加密
- 用RSA私钥对AES密钥进行加密
- 存储加密的PHR文档和加密的AES密钥

推荐的解密流程如下：
- 根据RSA公钥和加密的AES密钥，解密出AES密钥
- 根据AES密钥和加密的PHR文档，解密出PHR文档

### 软件层面的用户认证

用户认证是对文档加密的补充，需要根据软件的具体形式选择适合的认证方式，常见的认证方式有：
- 密码认证
- 二维码认证
- 手机验证码认证
- 指纹、虹膜、人脸等生物信息认证
- 关键操作的二次认证




